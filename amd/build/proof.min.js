/**
 *
 * @package
 * @copyright  2025 Brian A. Pool
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_mooproof/proof",["jquery","core/ajax","core/notification","core/str"],(function($,Ajax,Notification,Str){return{init:function(mooproofid,maxwords,chatmessagelimit){var currentTab="paste",fileContent=null,fileName=null,currentPaper=null,currentFeedback=null,chatHistory=[],chatMessageCount=0;$(".mooproof-tab").on("click",(function(){var tab=$(this).data("tab");$(".mooproof-tab").removeClass("active"),$(this).addClass("active"),$(".mooproof-tab-content").removeClass("active"),$("#"+tab+"-tab").addClass("active"),currentTab=tab})),$("#mooproof-text-input").on("input",(function(){var words=$(this).val().trim().split(/\s+/).filter((function(word){return word.length>0})).length;$("#word-count").text(words),maxwords>0&&words>maxwords?$("#word-count").css("color","red"):$("#word-count").css("color","#333")})),$("#select-file-btn").on("click",(function(){$("#file-input").click()})),$("#file-input").on("change",(function(){var file=this.files[0];if(file){var ext=file.name.split(".").pop().toLowerCase();if("txt"!==ext&&"docx"!==ext)return Str.get_string("unsupportedfiletype","mooproof").done((function(str){alert(str)})),$(this).val(""),void $("#mooproof-file-name").html("");fileName=file.name,Str.get_string("selected","mooproof").done((function(str){$("#mooproof-file-name").html("<strong>"+str+"</strong> "+fileName)}));var reader=new FileReader;reader.onload=function(e){var content=e.target.result;"txt"===ext?fileContent=content:"docx"===ext&&(fileContent=content.split(",")[1],Str.get_string("fileuploadedextract","mooproof").done((function(str){$("#mooproof-file-name").append("<br><em>"+str+"</em>")})))},"txt"===ext?reader.readAsText(file):reader.readAsDataURL(file)}})),$("#mooproof-submit").on("click",(function(){var papertext="",filename="";if("paste"===currentTab){if(""===(papertext=$("#mooproof-text-input").val().trim()))return void Str.get_strings([{key:"error",component:"mooproof"},{key:"pleaseentertext",component:"mooproof"}]).done((function(strings){Notification.alert(strings[0],strings[1])}))}else{if(!fileContent)return void Str.get_strings([{key:"error",component:"mooproof"},{key:"pleaseselectfile",component:"mooproof"}]).done((function(strings){Notification.alert(strings[0],strings[1])}));papertext=fileContent,filename=fileName}var wordCount=papertext.trim().split(/\s+/).filter((function(word){return word.length>0})).length;maxwords>0&&wordCount>maxwords?Str.get_strings([{key:"wordlimitexceededtitle",component:"mooproof"},{key:"wordlimitexceeded",component:"mooproof"}]).done((function(strings){var message=strings[1].replace("{$a->count}",wordCount).replace("{$a->max}",maxwords);Notification.alert(strings[0],message)})):($("#mooproof-submit").prop("disabled",!0),$("#mooproof-loading-indicator").show(),$(".mooproof-input-section").hide(),Ajax.call([{methodname:"mod_mooproof_submit_paper",args:{mooproofid:mooproofid,papertext:papertext,filename:filename}}])[0].done((function(response){if($("#mooproof-loading-indicator").hide(),!response.success||response.error)Str.get_string("error","mooproof").done((function(str){Notification.alert(str,response.error)})),$(".mooproof-input-section").show(),0===response.remaining?$("#mooproof-submit").prop("disabled",!0):$("#mooproof-submit").prop("disabled",!1),updateRemainingDisplay(response.remaining);else if(response.success&&response.feedback){currentPaper=papertext,currentFeedback=response.feedback,chatHistory=[],chatMessageCount=0;var formattedFeedback=formatFeedback(response.feedback);$("#proofing-results").html(formattedFeedback),$("#results-section").show(),$("#chat-section").show(),$("#chat-messages").html(""),$("#chat-input").val("").prop("disabled",!1),$("#chat-send").prop("disabled",!1),updateChatRemaining(),updateRemainingDisplay(response.remaining)}})).fail((function(){$("#mooproof-loading-indicator").hide(),Str.get_strings([{key:"error",component:"mooproof"},{key:"failedconnectproofing",component:"mooproof"}]).done((function(strings){Notification.alert(strings[0],strings[1])})),$(".mooproof-input-section").show(),$("#mooproof-submit").prop("disabled",!1)})))}));var updateRemainingDisplay=function(remaining){remaining>=0&&Str.get_string("submissionsremaining","mooproof",remaining).done((function(str){var alertDivs=$("#results-section .alert-info").filter((function(){return-1!==$(this).text().toLowerCase().indexOf("submission")}));alertDivs.length>0&&alertDivs.first().html("<strong>"+str+"</strong>")}))};$("#mooproof-reset").on("click",(function(){$("#results-section").hide(),$("#chat-section").hide(),$(".mooproof-input-section").show(),$("#mooproof-text-input").val(""),$("#word-count").text("0"),fileContent=null,$("#mooproof-file-name").html(""),$("#file-input").val(""),$(".mooproof-tab").removeClass("active"),$('.mooproof-tab[data-tab="paste"]').addClass("active"),$(".mooproof-tab-content").removeClass("active"),$("#paste-tab").addClass("active"),currentTab="paste",0===$('#results-section .alert-info:contains("Submissions remaining: 0")').length&&0===$('#results-section .alert-info:contains("0")').length&&$("#mooproof-submit").prop("disabled",!1)}));var formatFeedback=function(text){var escaped=escapeHtml(text);return escaped=(escaped=(escaped=(escaped="<p>"+(escaped=(escaped=(escaped=(escaped=(escaped=escaped.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")).replace(/__([^_]+)__/g,"<strong>$1</strong>")).replace(/\*([^*\n]+)\*/g,"<em>$1</em>")).replace(/\n\n+/g,"</p><p>")).replace(/\n/g,"<br>"))+"</p>").replace(/(\d+)\.\s/g,"<br><strong>$1.</strong> ")).replace(/<br>[-*]\s+/g,"<br>• ")).replace(/<p>[-*]\s+/g,"<p>• ")},escapeHtml=function(text){var div=document.createElement("div");return div.textContent=text,div.innerHTML};$("#chat-send").on("click",(function(){sendChatMessage()})),$("#chat-input").on("keypress",(function(e){13!==e.which||e.shiftKey||(e.preventDefault(),sendChatMessage())}));var sendChatMessage=function(){var message=$("#chat-input").val().trim();if(""!==message&&currentPaper&&currentFeedback)if(chatMessageCount>=chatmessagelimit)Str.get_strings([{key:"limitreached",component:"mooproof"},{key:"maxquestionsreached",component:"mooproof"}]).done((function(strings){Notification.alert(strings[0],strings[1])}));else{$("#chat-input").prop("disabled",!0),$("#chat-send").prop("disabled",!0),addChatMessage("user",message),chatHistory.push({role:"user",content:message}),chatMessageCount++,$("#chat-input").val("");var thinkingId="chat-thinking-"+Date.now();Str.get_string("thinking","mooproof").done((function(str){$("#chat-messages").append('<div class="mooproof-chat-message mooproof-chat-assistant" id="'+thinkingId+'"><em>'+str+"</em></div>"),scrollChatToBottom()})),Ajax.call([{methodname:"mod_mooproof_send_chat_message",args:{mooproofid:mooproofid,message:message,papertext:currentPaper,feedback:currentFeedback,chathistory:JSON.stringify(chatHistory)}}])[0].done((function(response){$("#"+thinkingId).remove(),!response.success||response.error?(Str.get_string("error","mooproof").done((function(str){Notification.alert(str,response.error)})),0===response.remaining&&($("#chat-input").prop("disabled",!0),$("#chat-send").prop("disabled",!0))):response.success&&response.reply&&(addChatMessage("assistant",response.reply),chatHistory.push({role:"assistant",content:response.reply}),updateChatRemaining()),chatMessageCount<chatmessagelimit?($("#chat-input").prop("disabled",!1),$("#chat-send").prop("disabled",!1),$("#chat-input").focus()):($("#chat-input").prop("disabled",!0),$("#chat-send").prop("disabled",!0))})).fail((function(){$("#"+thinkingId).remove(),Str.get_strings([{key:"error",component:"mooproof"},{key:"failedconnectchat",component:"mooproof"}]).done((function(strings){Notification.alert(strings[0],strings[1])})),$("#chat-input").prop("disabled",!1),$("#chat-send").prop("disabled",!1)}))}},addChatMessage=function(role,content){var messageHtml='<div class="mooproof-chat-message '+("user"===role?"mooproof-chat-user":"mooproof-chat-assistant")+'">'+formatFeedback(content)+"</div>";$("#chat-messages").append(messageHtml),scrollChatToBottom()},updateChatRemaining=function(){var remaining=chatmessagelimit-chatMessageCount;Str.get_string("questionsremaining","mooproof",remaining).done((function(str){$("#chat-remaining").text(str)}))},scrollChatToBottom=function(){var chatMessages=$("#chat-messages");chatMessages.scrollTop(chatMessages[0].scrollHeight)}}}}));

//# sourceMappingURL=proof.min.js.map